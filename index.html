<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>データ分析 - 折れ線グラフ表示</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- Chart.js and Luxon Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f4f9;
        }
        .controls, .chart-container {
            width: 100%;
            max-width: 800px;
            margin: 20px;
        }
        .scrollable-chart {
            width: 100%;
            overflow-x: auto;
            margin-top: 20px;
        }
        .scrollable-chart canvas {
            min-width: 1000px;
        }
        h2 {
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>データ分析 - 折れ線グラフ表示</h1>

    <!-- Date Range Inputs -->
    <div class="controls">
        <h2>1日目の時間範囲</h2>
        <label>開始時刻:
            <input type="datetime-local" id="day1StartTime" />
        </label>
        <label>終了時刻:
            <input type="datetime-local" id="day1EndTime" />
        </label>
    </div>
    <div class="controls">
        <h2>2日目の時間範囲</h2>
        <label>開始時刻:
            <input type="datetime-local" id="day2StartTime" />
        </label>
        <label>終了時刻:
            <input type="datetime-local" id="day2EndTime" />
        </label>
        <button onclick="fetchDataAndDrawCharts()">グラフを更新</button>
    </div>

    <!-- Line Charts -->
    <div class="scrollable-chart">
        <h2>1日目のデータ</h2>
        <canvas id="day1LineChart"></canvas>
    </div>
    <div class="scrollable-chart">
        <h2>2日目のデータ</h2>
        <canvas id="day2LineChart"></canvas>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDfmjWjPl786cVBXzqlsiZsS4MUFbwrNNM",
            authDomain: "school-festival-e4c8d.firebaseapp.com",
            databaseURL: "https://school-festival-e4c8d-default-rtdb.firebaseio.com",
            projectId: "school-festival-e4c8d",
            storageBucket: "school-festival-e4c8d.appspot.com",
            messagingSenderId: "658868728855",
            appId: "1:658868728855:web:8d7497c6838f5a42d21852"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let day1LineChart, day2LineChart;

        // Fetch data and draw charts
        function fetchDataAndDrawCharts() {
            const day1StartTime = new Date(document.getElementById('day1StartTime').value);
            const day1EndTime = new Date(document.getElementById('day1EndTime').value);
            const day2StartTime = new Date(document.getElementById('day2StartTime').value);
            const day2EndTime = new Date(document.getElementById('day2EndTime').value);

            const logsRef = database.ref('logs');
            logsRef.once('value').then(snapshot => {
                const logs = snapshot.val();
                const day1Logs = filterLogsByDate(logs, 'day1', day1StartTime, day1EndTime);
                const day2Logs = filterLogsByDate(logs, 'day2', day2StartTime, day2EndTime);
                drawLineCharts(day1Logs, day2Logs);
            });
        }

        // Filter logs by date
        function filterLogsByDate(logs, day, startTime, endTime) {
            const filteredLogs = [];

            Object.values(logs).forEach(log => {
                const logTime = new Date(log.timestamp);
                if (log.day === day && logTime >= startTime && logTime <= endTime) {
                    filteredLogs.push(log);
                }
            });

            return filteredLogs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        }

        // Draw line charts
        function drawLineCharts(day1Logs, day2Logs) {
            const day1Data = processLogs(day1Logs);
            const day2Data = processLogs(day2Logs);

            const day1LineChartCtx = document.getElementById('day1LineChart').getContext('2d');
            const day2LineChartCtx = document.getElementById('day2LineChart').getContext('2d');

            if (day1LineChart) day1LineChart.destroy();
            if (day2LineChart) day2LineChart.destroy();

            day1LineChart = new Chart(day1LineChartCtx, {
                type: 'line',
                data: {
                    labels: day1Data.timestamps,
                    datasets: day1Data.datasets
                },
                options: getChartOptions('1日目の販売数の推移')
            });

            day2LineChart = new Chart(day2LineChartCtx, {
                type: 'line',
                data: {
                    labels: day2Data.timestamps,
                    datasets: day2Data.datasets
                },
                options: getChartOptions('2日目の販売数の推移')
            });
        }

        // Prepare data for line charts
        function processLogs(logs) {
            const timestamps = [];
            const datasets = {
                plain: { label: 'プレーン', data: [], borderColor: '#007BFF', fill: false },
                choco: { label: 'チョコ', data: [], borderColor: '#8B4513', fill: false },
                strawberry: { label: 'いちご', data: [], borderColor: '#FF6347', fill: false },
                matcha: { label: '抹茶', data: [], borderColor: '#3CB371', fill: false },
                jdk: { label: 'JDK', data: [], borderColor: '#FFD700', fill: false }
            };

            logs.forEach(log => {
                const timestamp = new Date(log.timestamp);
                timestamps.push(timestamp);
                datasets[log.type].data.push(log.newCount);
            });

            return {
                timestamps: timestamps,
                datasets: Object.values(datasets)
            };
        }

        // Get chart options
        function getChartOptions(title) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour',
                            displayFormats: {
                                hour: 'MMM D, HH:mm'
                            }
                        },
                        title: {
                            display: true,
                            text: '時間'
                        },
                        ticks: {
                            maxRotation: 0,
                            autoSkip: true
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'カウント数'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: title
                    }
                }
            };
        }

        // Initial setup
        fetchDataAndDrawCharts();
    </script>
</body>
</html>
