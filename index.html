<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>グラフ表示サイト</title>
    <!-- Include Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f4f4f9;
        }
        .chart-container {
            width: 80%;
            max-width: 800px;
            margin: 20px 0;
        }
        h2 {
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>データ分析 - グラフ表示</h1>
    
    <!-- Charts for Day 1 -->
    <h2>1日目のデータ</h2>
    <div class="chart-container">
        <canvas id="day1PieChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="day1LineChart"></canvas>
    </div>

    <!-- Charts for Day 2 -->
    <h2>2日目のデータ</h2>
    <div class="chart-container">
        <canvas id="day2PieChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="day2LineChart"></canvas>
    </div>

    <script>
    // Firebase の初期設定
    const firebaseConfig = {
        apiKey: "AIzaSyDfmjWjPl786cVBXzqlsiZsS4MUFbwrNNM",
        authDomain: "school-festival-e4c8d.firebaseapp.com",
        databaseURL: "https://school-festival-e4c8d-default-rtdb.firebaseio.com",
        projectId: "school-festival-e4c8d",
        storageBucket: "school-festival-e4c8d.appspot.com",
        messagingSenderId: "658868728855",
        appId: "1:658868728855:web:8d7497c6838f5a42d21852"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // データを取得してグラフを描画する
    function fetchDataAndDrawCharts() {
        const countersRef = database.ref('counters');
        const logsRef = database.ref('logs');

        countersRef.once('value').then(snapshot => {
            const counters = snapshot.val();
            drawPieCharts(counters.day1, counters.day2);
        });

        logsRef.once('value').then(snapshot => {
            const logs = snapshot.val();
            const day1Logs = [];
            const day2Logs = [];

            // ログを日ごとに分ける
            Object.values(logs).forEach(log => {
                if (log.day === 'day1') {
                    day1Logs.push(log);
                } else if (log.day === 'day2') {
                    day2Logs.push(log);
                }
            });

            drawLineCharts(day1Logs, day2Logs);
        });
    }

    // 円グラフを描画する
    function drawPieCharts(day1Data, day2Data) {
        const day1PieChartCtx = document.getElementById('day1PieChart').getContext('2d');
        const day2PieChartCtx = document.getElementById('day2PieChart').getContext('2d');

        // 1日目の円グラフ
        new Chart(day1PieChartCtx, {
            type: 'pie',
            data: {
                labels: ['プレーン', 'チョコ', 'いちご', '抹茶', 'JDK'],
                datasets: [{
                    data: [
                        day1Data.plain,
                        day1Data.choco,
                        day1Data.strawberry,
                        day1Data.matcha,
                        day1Data.jdk
                    ],
                    backgroundColor: ['#007BFF', '#8B4513', '#FF6347', '#3CB371', '#FFD700']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: '1日目の販売数分布'
                    }
                }
            }
        });

        // 2日目の円グラフ
        new Chart(day2PieChartCtx, {
            type: 'pie',
            data: {
                labels: ['プレーン', 'チョコ', 'いちご', '抹茶', 'JDK'],
                datasets: [{
                    data: [
                        day2Data.plain,
                        day2Data.choco,
                        day2Data.strawberry,
                        day2Data.matcha,
                        day2Data.jdk
                    ],
                    backgroundColor: ['#007BFF', '#8B4513', '#FF6347', '#3CB371', '#FFD700']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: '2日目の販売数分布'
                    }
                }
            }
        });
    }

    // 折れ線グラフを描画する
    function drawLineCharts(day1Logs, day2Logs) {
        const day1LineChartCtx = document.getElementById('day1LineChart').getContext('2d');
        const day2LineChartCtx = document.getElementById('day2LineChart').getContext('2d');

        const day1Data = processLogs(day1Logs);
        const day2Data = processLogs(day2Logs);

        // 1日目の折れ線グラフ
        new Chart(day1LineChartCtx, {
            type: 'line',
            data: {
                labels: day1Data.timestamps,
                datasets: day1Data.datasets
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: '1日目の販売数の推移'
                    }
                }
            }
        });

        // 2日目の折れ線グラフ
        new Chart(day2LineChartCtx, {
            type: 'line',
            data: {
                labels: day2Data.timestamps,
                datasets: day2Data.datasets
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: '2日目の販売数の推移'
                    }
                }
            }
        });
    }

    // ログを処理して折れ線グラフのデータ形式に変換する
    function processLogs(logs) {
        const timestamps = [];
        const datasets = {
            plain: [],
            choco: [],
            strawberry: [],
            matcha: [],
            jdk: []
        };

        logs.forEach(log => {
            if (!timestamps.includes(log.timestamp)) {
                timestamps.push(log.timestamp);
            }
            datasets[log.type].push(log.newCount);
        });

        return {
            timestamps: timestamps,
            datasets: [
                {
                    label: 'プレーン',
                    data: datasets.plain,
                    borderColor: '#007BFF',
                    fill: false
                },
                {
                    label: 'チョコ',
                    data: datasets.choco,
                    borderColor: '#8B4513',
                    fill: false
                },
                {
                    label: 'いちご',
                    data: datasets.strawberry,
                    borderColor: '#FF6347',
                    fill: false
                },
                {
                    label: '抹茶',
                    data: datasets.matcha,
                    borderColor: '#3CB371',
                    fill: false
                },
                {
                    label: 'JDK',
                    data: datasets.jdk,
                    borderColor: '#FFD700',
                    fill: false
                }
            ]
        };
    }

    fetchDataAndDrawCharts();
    </script>
</body>
</html>
