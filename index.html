<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>グラフ表示サイト</title>
    <!-- Include Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <!-- Include Chart.js and Luxon Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f4f4f9;
        }
        .chart-container {
            width: 100%;
            max-width: 800px;
            margin: 20px 0;
        }
        .scrollable-chart {
            width: 100%;
            overflow-x: auto; /* Enable horizontal scrolling */
            margin: 20px 0;
            white-space: nowrap; /* Prevent child elements from wrapping */
        }
        .scrollable-chart canvas {
            min-width: 1000px; /* Increase width to enable scrolling */
        }
        h2 {
            text-align: center;
        }
        .controls {
            margin: 10px 0;
        }
        .controls label {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <h1>データ分析 - 折れ線グラフ表示</h1>
    
    <!-- 1日目の時間範囲の設定 -->
    <div class="controls">
        <h2>1日目の時間範囲</h2>
        <label>開始時刻:
            <input type="datetime-local" id="day1StartTime" />
        </label>
        <label>終了時刻:
            <input type="datetime-local" id="day1EndTime" />
        </label>
    </div>

    <!-- 2日目の時間範囲の設定 -->
    <div class="controls">
        <h2>2日目の時間範囲</h2>
        <label>開始時刻:
            <input type="datetime-local" id="day2StartTime" />
        </label>
        <label>終了時刻:
            <input type="datetime-local" id="day2EndTime" />
        </label>
        <button onclick="fetchDataAndDrawCharts()">グラフを更新</button>
    </div>

    <!-- Line Charts for Day 1 -->
    <h2>1日目のデータ</h2>
    <div class="scrollable-chart">
        <canvas id="day1LineChart"></canvas>
    </div>

    <!-- Line Charts for Day 2 -->
    <h2>2日目のデータ</h2>
    <div class="scrollable-chart">
        <canvas id="day2LineChart"></canvas>
    </div>

    <script>
    // Firebase の初期設定
    const firebaseConfig = {
        apiKey: "AIzaSyDfmjWjPl786cVBXzqlsiZsS4MUFbwrNNM",
        authDomain: "school-festival-e4c8d.firebaseapp.com",
        databaseURL: "https://school-festival-e4c8d-default-rtdb.firebaseio.com",
        projectId: "school-festival-e4c8d",
        storageBucket: "school-festival-e4c8d.appspot.com",
        messagingSenderId: "658868728855",
        appId: "1:658868728855:web:8d7497c6838f5a42d21852"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // グラフインスタンスの保持用変数
    let day1LineChart, day2LineChart;

    // データを取得してグラフを描画する
    function fetchDataAndDrawCharts() {
        const logsRef = database.ref('logs');
        const day1StartTime = new Date(document.getElementById('day1StartTime').value);
        const day1EndTime = new Date(document.getElementById('day1EndTime').value);
        const day2StartTime = new Date(document.getElementById('day2StartTime').value);
        const day2EndTime = new Date(document.getElementById('day2EndTime').value);

        logsRef.once('value').then(snapshot => {
            const logs = snapshot.val();
            processLogUpdates(logs, day1StartTime, day1EndTime, day2StartTime, day2EndTime);
        });
    }

    // リアルタイムデータのリスナーを設定
    function setupRealtimeListeners() {
        const logsRef = database.ref('logs');

        logsRef.on('value', snapshot => {
            const logs = snapshot.val();
            const day1StartTime = new Date(document.getElementById('day1StartTime').value);
            const day1EndTime = new Date(document.getElementById('day1EndTime').value);
            const day2StartTime = new Date(document.getElementById('day2StartTime').value);
            const day2EndTime = new Date(document.getElementById('day2EndTime').value);
            processLogUpdates(logs, day1StartTime, day1EndTime, day2StartTime, day2EndTime);
        });
    }

    // ログデータを処理してグラフを更新
    function processLogUpdates(logs, day1StartTime, day1EndTime, day2StartTime, day2EndTime) {
        const day1Logs = [];
        const day2Logs = [];

        Object.values(logs).forEach(log => {
            const logTime = new Date(log.timestamp);
            if (log.day === 'day1' && logTime >= day1StartTime && logTime <= day1EndTime) {
                day1Logs.push(log);
            }
            if (log.day === 'day2' && logTime >= day2StartTime && logTime <= day2EndTime) {
                day2Logs.push(log);
            }
        });

        drawLineCharts(day1Logs, day2Logs);
    }

    // 折れ線グラフを描画する
    function drawLineCharts(day1Logs = [], day2Logs = []) {
        const day1LineChartCtx = document.getElementById('day1LineChart').getContext('2d');
        const day2LineChartCtx = document.getElementById('day2LineChart').getContext('2d');

        if (day1LineChart) day1LineChart.destroy();
        if (day2LineChart) day2LineChart.destroy();

        const day1Data = processLogs(day1Logs);
        const day2Data = processLogs(day2Logs);

        // 1日目の折れ線グラフ
        day1LineChart = new Chart(day1LineChartCtx, {
            type: 'line',
            data: {
                labels: day1Data.timestamps,
                datasets: day1Data.datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour',
                            displayFormats: {
                                hour: 'MMM D, HH:mm'
                            }
                        },
                        min: day1Data.timestamps[0] || null,
                        max: day1Data.timestamps[day1Data.timestamps.length - 1] || null,
                        ticks: {
                            maxRotation: 0,
                            autoSkip: true,
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'カウント数'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: '1日目の販売数の推移'
                    }
                }
            }
        });

        // 2日目の折れ線グラフ
        day2LineChart = new Chart(day2LineChartCtx, {
            type: 'line',
            data: {
                labels: day2Data.timestamps,
                datasets: day2Data.datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour',
                            displayFormats: {
                                hour: 'MMM D, HH:mm'
                            }
                        },
                        min: day2Data.timestamps[0] || null,
                        max: day2Data.timestamps[day2Data.timestamps.length - 1] || null,
                        ticks: {
                            maxRotation: 0,
                            autoSkip: true,
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'カウント数'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: '2日目の販売数の推移'
                    }
                }
            }
        });
    }

    // ログを処理して折れ線グラフのデータ形式に変換する
    function processLogs(logs) {
        const timestamps = [];
        const datasets = {
            plain: [],
            choco: [],
            strawberry: [],
            matcha: [],
            jdk: []
        };

        logs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); // 時間順にソート

        logs.forEach(log => {
            const timestamp = new Date(log.timestamp);
            timestamps.push(timestamp);

            // 各ログのカウント数の値をそのまま使用
            datasets[log.type].push(log.newCount);
        });

        return {
            timestamps: timestamps,
            datasets: [
                {
                    label: 'プレーン',
                    data: datasets.plain,
                    borderColor: '#007BFF',
                    fill: false
                },
                {
                    label: 'チョコ',
                    data: datasets.choco,
                    borderColor: '#8B4513',
                    fill: false
                },
                {
                    label: 'いちご',
                    data: datasets.strawberry,
                    borderColor: '#FF6347',
                    fill: false
                },
                {
                    label: '抹茶',
                    data: datasets.matcha,
                    borderColor: '#3CB371',
                    fill: false
                },
                {
                    label: 'JDK',
                    data: datasets.jdk,
                    borderColor: '#FFD700',
                    fill: false
                }
            ]
        };
    }

    // 初期化
    fetchDataAndDrawCharts();
    setupRealtimeListeners();
    </script>
</body>
</html>
