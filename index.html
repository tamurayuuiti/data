<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カウント数の推移グラフ</title>
    <!-- Chart.js ライブラリの読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <!-- Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <h1>カウント数の推移グラフ</h1>
    <h2>1日目 (2024年9月12日 00:00 - 23:59)</h2>
    <canvas id="day1Chart" width="400" height="200"></canvas>
    
    <h2>2日目 (2024年9月14日 09:00 - 16:00)</h2>
    <canvas id="day2Chart" width="400" height="200"></canvas>

    <script>
        // Firebaseの設定
        const firebaseConfig = {
            apiKey: "AIzaSyDfmjWjPl786cVBXzqlsiZsS4MUFbwrNNM",
            authDomain: "school-festival-e4c8d.firebaseapp.com",
            databaseURL: "https://school-festival-e4c8d-default-rtdb.firebaseio.com",
            projectId: "school-festival-e4c8d",
            storageBucket: "school-festival-e4c8d.appspot.com",
            messagingSenderId: "658868728855",
            appId: "1:658868728855:web:8d7497c6838f5a42d21852"
        };

        // Firebaseの初期化
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const logRef = database.ref('logs');

        // 期間設定
        const day1Start = new Date('2024-09-12T00:00:00');
        const day1End = new Date('2024-09-12T23:59:59');
        const day2Start = new Date('2024-09-14T09:00:00');
        const day2End = new Date('2024-09-14T16:00:00');

        // リアルタイムでデータを監視
        logRef.on('value', snapshot => {
            if (snapshot.exists()) {
                const logs = snapshot.val();
                const day1Data = filterDataByDate(logs, day1Start, day1End);
                const day2Data = filterDataByDate(logs, day2Start, day2End);
                drawChart('day1Chart', prepareChartData(day1Data));
                drawChart('day2Chart', prepareChartData(day2Data));
            }
        });

        // 日付範囲でデータをフィルタリング
        function filterDataByDate(logs, startDate, endDate) {
            const filteredData = {};
            for (const key in logs) {
                const log = logs[key];
                const timestamp = new Date(log.timestamp);
                if (timestamp >= startDate && timestamp <= endDate) {
                    filteredData[key] = log;
                }
            }
            return filteredData;
        }

        // ログデータを時系列で整形
        function prepareChartData(logs) {
            const dataByType = {
                plain: [],
                choco: [],
                strawberry: [],
                matcha: [],
                jdk: []
            };
            const labels = [];

            for (const key in logs) {
                const log = logs[key];
                const timestamp = log.timestamp;
                const type = log.type;
                const count = log.newCount;

                if (!labels.includes(timestamp)) {
                    labels.push(timestamp);
                }

                dataByType[type].push(count);
            }

            return { labels, dataByType };
        }

        // グラフ描画
        function drawChart(canvasId, chartData) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'プレーン',
                            data: chartData.dataByType.plain,
                            borderColor: 'blue',
                            fill: false
                        },
                        {
                            label: 'チョコ',
                            data: chartData.dataByType.choco,
                            borderColor: 'brown',
                            fill: false
                        },
                        {
                            label: 'いちご',
                            data: chartData.dataByType.strawberry,
                            borderColor: 'red',
                            fill: false
                        },
                        {
                            label: '抹茶',
                            data: chartData.dataByType.matcha,
                            borderColor: 'green',
                            fill: false
                        },
                        {
                            label: 'JDK',
                            data: chartData.dataByType.jdk,
                            borderColor: 'yellow',
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'minute'
                            }
                        },
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
